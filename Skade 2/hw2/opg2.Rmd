---
title: "Homework 1, skade2"
subtitle: 'Anna Sailegtim, Jens Fischer, Peter Garde'
output:
  pdf_document: default
  html_document: default
date: "2024-06-10"
---
\section{R exercise 1}
\subsection{a)}
```{r include=TRUE}
options(scipen = 99)
library(ggplot2)
library(tidyverse)

claim_pre = read_csv("claims.csv")
claim = claim_pre %>%
  mutate(Clr = Clr / 1000,
         Dedr = Dedr / 1000,
         Age=log(Age+2),
         Brt=log(Brt),
         Dwt=log(Dwt),
         Value=log(Value),
         HP=log(HP),
         Stroke = factor(Stroke),
         Code1 = factor(Code1))

model = model.matrix(Clr ~ Age + Brt + Dwt + Value + HP + Stroke + Code1, claim)

phi = (312 - 1)^(-1)
mu = phi * 1.98

beta = c(mu, rep(0, ncol(model) - 1), phi)

log_likelihood_pareto = function(beta){
  return( -sum( log(pareto_G_optim(model, beta)) 
                - log(pareto_G_survival_func_optim(claim$Dedr, beta)) ) )
}

log_likelihood = function(beta, phi, x, d, modelMatrix){
  phiInverse = phi^(-1)
  return(
    length(x) * log(1 + phi)
    + sum( apply(cbind(modelMatrix, x, d), 
            1,
            function(row) (1 + phiInverse)*log( 
              exp(beta %*% row[1:(length(row)-2)] + phi * row[length(row)])) 
           - (2 + phiInverse) * log( exp(beta %*% row[1:(length(row)-2)] 
                                         + phi * row[length(row) - 1]) ) ) )
    )
}

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model) )
}

optim_param = optim(beta, log_likelihood_optim)

beta = optim_param$par[1:(length(optim_param$par) - 1)]
beta

phi = optim_param$par[length(optim_param$par)]
phi
```
We note that phi is negative which is quite peculiare. This might be because the r optim function has not congerged. We are not sure why this is the case. Further more phi and mu from our last was not parameterized to the G-Pareto dist. from the book. Thus these const. as starting values might be problematic.

\subsection{b)}
We apply backward selection where the model with the lowest AIC is chosen.
```{r}
AIC = function(r, l){
  return(2*l - 2*r)
}
AIC(length(optim_param$par), log_likelihood_optim(optim_param$par))



formula = Clr ~ Brt + Dwt + Value + HP + Stroke + Code1
model.m = model.matrix(formula, claim)

phi = (312 - 1)^(-1)
mu = phi * 1.98

beta = c(mu, rep(0, ncol(model) - 1), phi)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)


```

Full: 1399500
Age: 1399192

Age removed.
```{r}
formula = Clr ~ Brt + Dwt + Value + HP + Stroke 
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```

Brt: 1399301
Dwt: 1399301
Value: 1399307
HP: 1399307
Stroke: 1399417
Code1: 24425.14

Remove Code1
```{r}
formula = Clr ~ Dwt + Value + HP + Stroke 
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Brt: -326245.6

```{r}
formula = Clr ~ Dwt + Value + HP + Stroke 
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Dwt: -264989.7
Value: -98277.82 
HP: 99326.02
Stroke: 748955.1

We have thus found the best model by applying backward selection
```{r}
beta0 = optim_param$par[1:(length(optim_param$par)- 1)]
phi0 = optim_param$par[length(optim_param$par)]

beta0
phi0
```

\subsection{c)}
```{r}
claim_pre = read_csv("claims.csv")
claim = claim_pre %>%
  mutate(Clr = Clr / 1000000,
         Dedr = Dedr / 1000000,
         Age=log(Age+2),
         Brt=log(Brt),
         Dwt=log(Dwt),
         Value=log(Value),
         HP=log(HP),
         Stroke = factor(Stroke),
         Code1 = factor(Code1))

phi = (312 - 1)^(-1)
mu = phi * 1.98

beta = c(mu, rep(0, ncol(model) - 1), phi)
```
```{r}
formula = Clr ~ Brt + Dwt + Value + HP + Stroke + Code1
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Full: -81573.54 
Age: -231795.3

We remove Age

```{r}
formula = Clr ~ Dwt + Value + HP + Stroke + Code1
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Brt: -856889.5

We remove Brt
```{r warning=FALSE}
formula = Clr ~ Value + HP + Stroke + Code1
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Dwt: -1705258

We remove Dwt

```{r warning=FALSE}
formula = Clr ~ Value + Stroke + HP
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Value: -464538.3
HP: -829095.9
Code1: -1894167

We remove Code1
```{r warning=FALSE}
formula = Clr ~ Value +  HP
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Value: -1858249 
Stroke: -1900667

We remove Stroke

```{r warning=FALSE}
formula = Clr ~ Value
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Value: -1815618  
HP: -1903760

We remove HP
```{r warning=FALSE}
formula = Clr ~ 1
model.m = model.matrix(formula, claim)

log_likelihood_optim = function(beta){
  return( -log_likelihood(beta[1:(length(beta)-1)], beta[length(beta)], 
                          claim$Clr, claim$Dedr, model.m ) )
}
beta = c(mu, rep(0, ncol(model.m) - 1), phi)

optim_param = optim(beta, log_likelihood_optim)

l = log_likelihood_optim(optim_param$par)

AIC(length(optim_param$par), l)
```
Value: -2212313

We remove Value. Only the intercept is kept in the final model.

```{r}
beta0 = optim_param$par[1]
phi0 = optim_param$par[2]

beta0
phi0
```
Compared to b) we get a totally different result. Here none of the covariate holds enougth information to be kept in the model. We suspect that that the exp(.) in the log-likelihood of G-Pareto might be troublesome. As the claims and deductables gets very small. Its not certain that this is the root of the change.

